# Screenshot to Eagle - 技术实现文档

## 技术栈

### 开发环境
- **Node.js**: 22.13.10
- **TypeScript**: 5.8.2
- **Raycast API**: 1.103.6
- **开发工具**: VS Code

### 核心依赖
```json
{
  "@raycast/api": "^1.103.6",
  "@raycast/utils": "^1.17.0"
}
```

### 开发依赖
```json
{
  "@raycast/eslint-config": "^2.0.4",
  "@types/node": "22.13.10",
  "@types/react": "19.0.10",
  "eslint": "^9.22.0",
  "prettier": "^3.5.3",
  "typescript": "^5.8.2"
}
```

## 架构设计

### 整体架构

```
┌─────────────────────────────────────────────────┐
│                  Raycast 插件                    │
├─────────────────────────────────────────────────┤
│                                                  │
│  ┌────────────────┐      ┌──────────────────┐  │
│  │  shot-to-eagle │      │  select-folder   │  │
│  │   (主命令)      │      │  (文件夹选择)     │  │
│  └────────┬───────┘      └────────┬─────────┘  │
│           │                       │             │
│           └───────────┬───────────┘             │
│                       │                         │
│           ┌───────────▼──────────┐              │
│           │   Config Module      │              │
│           │   (配置管理)          │              │
│           └───────────┬──────────┘              │
│                       │                         │
│           ┌───────────┴──────────┐              │
│           │                      │              │
│  ┌────────▼──────────┐  ┌───────▼──────────┐  │
│  │ Screenshot Module │  │  Eagle API       │  │
│  │ (截图功能)         │  │  Module          │  │
│  └────────┬──────────┘  └───────┬──────────┘  │
│           │                     │              │
│           │                     │              │
│           │      ┌──────────────▼──────────┐   │
│           │      │   Utils (工具函数)       │   │
│           │      └─────────────────────────┘   │
│           │                                     │
└───────────┼─────────────────────────────────────┘
            │
            │
    ┌───────▼─────────┐          ┌──────────────┐
    │ macOS           │          │  Eagle App   │
    │ screencapture   │          │  Web API     │
    └─────────────────┘          └──────────────┘
```

### 模块划分

#### 1. Types Module (`src/types/index.ts`)
**职责**：定义所有 TypeScript 类型和接口

**主要类型**：
- `EagleFolder`: Eagle 文件夹结构
- `EagleApiResponse<T>`: Eagle API 响应格式
- `PluginConfig`: 插件配置
- `ScreenshotMode`: 截图模式枚举
- `ScreenshotResult`: 截图结果
- `UploadResult`: 上传结果

#### 2. Utils Module (`src/utils/index.ts`)
**职责**：提供通用工具函数

**主要函数**：
```typescript
// 文件名生成
generateFileName(): string
// 格式：Screenshot_YYYY-MM-DD_HH-mm-ss.png

// Base64 转换
fileToBase64(filePath: string): Promise<string>
// 返回：data:image/png;base64,...

// 文件操作
fileExists(filePath: string): Promise<boolean>
deleteFile(filePath: string): Promise<void>
getTempFilePath(filename?: string): string

// 字符串处理
parseTags(tagsString: string): string[]
formatError(error: unknown): string
```

#### 3. Config Module (`src/modules/config.ts`)
**职责**：管理插件配置

**配置来源优先级**：
1. LocalStorage（UI 选择的文件夹）
2. Preferences（用户手动配置）
3. 默认值

**主要函数**：
```typescript
// 获取配置
async getConfig(): Promise<PluginConfig>

// 验证配置
validateConfig(config: PluginConfig): {
  isValid: boolean;
  errors: string[];
}

// 构建 API URL（支持 Token）
async getEagleApiUrl(endpoint: string): Promise<string>
```

#### 4. Eagle API Module (`src/modules/eagle-api.ts`)
**职责**：与 Eagle Web API 交互

**API 端点**：
- `GET /api/application/info` - 检查状态
- `GET /api/folder/list` - 获取文件夹列表
- `GET /api/folder/listRecent` - 获取最近文件夹
- `POST /api/item/addFromURL` - 上传图片

**主要函数**：
```typescript
// 状态检查（3秒超时）
async checkEagleStatus(): Promise<boolean>

// 文件夹操作
async getFolderList(): Promise<EagleFolder[]>
async getRecentFolders(): Promise<EagleFolder[]>
async validateFolderId(folderId: string): Promise<boolean>
async getFolderName(folderId: string): Promise<string | null>

// 上传操作
async uploadScreenshot(options: UploadScreenshotOptions): Promise<UploadResult>
```

#### 5. Screenshot Module (`src/modules/screenshot.ts`)
**职责**：执行 macOS 截图

**screencapture 命令参数**：
```bash
# 区域截图
screencapture -i output.png

# 窗口截图
screencapture -w output.png

# 全屏截图
screencapture output.png

# 延迟截图（5秒）
screencapture -T 5 -i output.png

# 包含鼠标指针
screencapture -C -i output.png

# 禁用声音
screencapture -x -i output.png
```

**主要函数**：
```typescript
// 通用截图
async takeScreenshot(options: ScreenshotOptions): Promise<ScreenshotResult>

// 快捷方法
async captureSelection(outputPath: string, ...): Promise<ScreenshotResult>
async captureWindow(outputPath: string, ...): Promise<ScreenshotResult>
async captureScreen(outputPath: string, ...): Promise<ScreenshotResult>
async captureWithDelay(outputPath: string, delay: number, ...): Promise<ScreenshotResult>
```

## 核心流程

### 主命令执行流程

```typescript
export default async function main() {
  try {
    // 1. 获取并验证配置
    const config = await getConfig();
    const validation = validateConfig(config);
    if (!validation.isValid) {
      // 显示错误
      return;
    }

    // 2. 检查 Eagle 状态
    const eagleRunning = await checkEagleStatus();
    if (!eagleRunning) {
      // 显示错误：Eagle 未运行
      return;
    }

    // 3. 执行截图
    showHUD("Taking Screenshot...");
    const fileName = generateFileName();
    const tempFilePath = getTempFilePath(fileName);
    
    const screenshotResult = await takeScreenshot({
      mode: config.defaultMode,
      outputPath: tempFilePath,
      includeCursor: config.includeCursor,
      playSound: config.playSound,
      delay: config.timedDelay,
    });

    // 4. 处理截图结果
    if (!screenshotResult.success) {
      if (screenshotResult.cancelled) {
        // 用户取消，静默返回
        return;
      }
      // 显示错误
      return;
    }

    // 5. 上传到 Eagle
    showHUD("Uploading to Eagle...");
    const base64Data = await fileToBase64(screenshotResult.filePath);
    const tags = parseTags(config.autoTags);
    
    const uploadResult = await uploadScreenshot({
      url: base64Data,
      name: fileName.replace(".png", ""),
      folderId: config.folderId,
      tags,
      modificationTime: Date.now(),
    });

    // 6. 清理临时文件
    await deleteFile(screenshotResult.filePath);

    // 7. 显示结果
    if (uploadResult.success) {
      showHUD("✓ Saved to Eagle");
    } else {
      // 显示错误
    }
  } catch (error) {
    // 全局错误处理
  }
}
```

### 文件夹选择 UI 流程

```typescript
export default function Command() {
  const [folders, setFolders] = useState<EagleFolder[]>([]);
  const [recentFolders, setRecentFolders] = useState<EagleFolder[]>([]);
  const [currentFolderId, setCurrentFolderId] = useState<string>("");

  // 加载数据
  useEffect(() => {
    loadFolders();
  }, []);

  async function loadFolders() {
    // 1. 检查 Eagle 状态
    const eagleRunning = await checkEagleStatus();
    if (!eagleRunning) return;

    // 2. 读取当前选择
    const savedFolderId = await LocalStorage.getItem(FOLDER_ID_KEY);
    setCurrentFolderId(savedFolderId);

    // 3. 获取文件夹列表
    const [allFolders, recent] = await Promise.all([
      getFolderList(),
      getRecentFolders()
    ]);

    setFolders(allFolders);
    setRecentFolders(recent);
  }

  async function selectFolder(folder: EagleFolder) {
    // 保存到 LocalStorage
    await LocalStorage.setItem(FOLDER_ID_KEY, folder.id);
    setCurrentFolderId(folder.id);
    // 显示成功提示
  }

  // 渲染 UI
  return (
    <List>
      {/* 当前选择 */}
      {/* 最近文件夹 */}
      {/* 所有文件夹 */}
    </List>
  );
}
```

## 数据流

### 配置数据流

```
用户输入 (Preferences)
         │
         ▼
    getConfig()
         │
         ├─► Preferences
         │   └─► eagleApiUrl, eagleApiToken, defaultMode, etc.
         │
         ├─► LocalStorage
         │   └─► folderId (UI 选择)
         │
         └─► 默认值
             └─► 合并返回 PluginConfig
```

### 截图上传数据流

```
用户触发命令
     │
     ▼
执行截图命令
     │
     ▼
临时文件
 (*.png)
     │
     ▼
读取文件
     │
     ▼
转换 Base64
     │
     ▼
Eagle API
 (POST)
     │
     ├─► Success
     │   └─► 显示成功
     │
     └─► Error
         └─► 显示错误
```

## 错误处理策略

### 错误类型

1. **配置错误**
   - 无效的 URL
   - 无效的延迟时间
   - 处理：显示 Toast，阻止执行

2. **Eagle 连接错误**
   - Eagle 未运行
   - API 超时
   - 处理：显示友好提示，引导用户

3. **截图错误**
   - 用户取消（ESC）
   - 权限不足
   - 处理：静默返回或显示提示

4. **上传错误**
   - 网络错误
   - 文件夹不存在
   - API 返回错误
   - 处理：显示详细错误信息

### 错误处理流程

```typescript
try {
  // 业务逻辑
} catch (error) {
  console.error("Error context:", error);
  
  await showToast({
    style: Toast.Style.Failure,
    title: "Error Title",
    message: formatError(error),
  });
}
```

## 性能优化

### 1. 并行请求
```typescript
// 同时获取所有文件夹和最近文件夹
const [allFolders, recent] = await Promise.all([
  getFolderList(),
  getRecentFolders()
]);
```

### 2. 超时控制
```typescript
// 使用 AbortController 实现 3 秒超时
const controller = new AbortController();
const timeoutId = setTimeout(() => controller.abort(), 3000);

const response = await fetch(url, {
  signal: controller.signal,
});

clearTimeout(timeoutId);
```

### 3. 临时文件清理
```typescript
// 上传后立即清理
await deleteFile(screenshotResult.filePath);
```

### 4. 错误提前返回
```typescript
// 验证失败立即返回
if (!validation.isValid) {
  await showToast({...});
  return; // 提前返回
}
```

## 安全考虑

### 1. API Token 安全
- Token 存储在 Raycast Preferences（加密存储）
- 不在日志中输出 Token
- URL 参数传递（HTTPS 安全）

### 2. 临时文件安全
- 使用系统临时目录（`os.tmpdir()`）
- 文件名使用时间戳（避免冲突）
- 使用后立即删除

### 3. 输入验证
- 验证 URL 格式
- 验证延迟时间范围（1-60 秒）
- 验证文件夹 ID 存在性

## 调试技巧

### 1. 查看日志
```typescript
console.log("Debug info:", data);
console.error("Error:", error);
```

### 2. Raycast Developer Tools
- 打开 Raycast
- 按 `⌘ + ⇧ + D` 打开开发者工具
- 查看 Console 日志

### 3. 测试 API
```bash
# 测试 Eagle 状态
curl http://localhost:41595/api/application/info

# 测试获取文件夹
curl http://localhost:41595/api/folder/list

# 测试上传（需要构造 JSON）
curl -X POST http://localhost:41595/api/item/addFromURL \
  -H "Content-Type: application/json" \
  -d '{"url":"data:image/png;base64,...","name":"test"}'
```

### 4. 断点调试
- 在 VS Code 中设置断点
- 使用 Raycast Developer 模式
- 查看变量状态

## 扩展性设计

### 1. 新增截图模式
```typescript
// 在 types/index.ts 添加新模式
export enum ScreenshotMode {
  // ...
  NEW_MODE = "new_mode",
}

// 在 screenshot.ts 添加处理逻辑
switch (options.mode) {
  // ...
  case ScreenshotMode.NEW_MODE:
    args.push("-x", "-y");
    break;
}
```

### 2. 新增配置项
```typescript
// 1. 在 package.json preferences 中添加
{
  "name": "newOption",
  "type": "checkbox",
  "title": "New Option"
}

// 2. 在 types/index.ts 添加到 PluginConfig
export interface PluginConfig {
  // ...
  newOption: boolean;
}

// 3. 在 config.ts 中读取
export async function getConfig(): Promise<PluginConfig> {
  // ...
  newOption: preferences.newOption ?? false,
}
```

### 3. 新增 Eagle API
```typescript
// 在 eagle-api.ts 中添加新函数
export async function newEagleApiFunction(): Promise<Result> {
  const url = await getEagleApiUrl("/api/new/endpoint");
  const response = await fetch(url, {...});
  // 处理响应
  return result;
}
```

## 性能指标

### 目标性能
- 截图响应：< 1 秒
- Eagle 状态检查：< 3 秒
- 文件上传：< 3 秒（1080p 截图）
- UI 响应：< 100ms

### 实际测试
需要在真实环境中测试：
- [ ] 不同分辨率截图的上传时间
- [ ] 网络延迟对上传的影响
- [ ] Eagle 文件夹数量对列表加载的影响

## 兼容性

### macOS 版本
- 最低要求：macOS 12.0
- 推荐：macOS 13.0+
- 原因：screencapture 命令兼容性

### Eagle 版本
- 最低要求：Eagle 3.0
- 推荐：最新版本
- 原因：Web API 功能

### Raycast 版本
- 最低要求：Raycast 1.50
- 推荐：最新版本
- 原因：API 特性使用

## 总结

这个项目采用了清晰的模块化架构，每个模块职责明确，易于维护和扩展。通过合理的错误处理、性能优化和安全考虑，提供了稳定可靠的用户体验。

技术亮点：
1. ✅ TypeScript 强类型保证代码质量
2. ✅ 模块化设计提高可维护性
3. ✅ 完善的错误处理提升用户体验
4. ✅ 异步编程保证流畅性
5. ✅ 清晰的代码注释便于理解

未来可以在此基础上添加更多高级功能，如截图编辑、OCR、智能标签等。
